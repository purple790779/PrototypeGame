<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>ÏßÄÏò§Î©îÌä∏Î¶¨ Ï∫êÎÖº - v37.2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --pad: 18px;
            --radius: 16px;
            --radius-lg: 20px;
            --glass: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.14);
            --accent: #00ffff;
            --accent-strong: #0088ff;
            --accent-hard: #ff3366;
            --shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
        }
        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            color: white;
            font-family: 'Pretendard', sans-serif;
            user-select: none;
            touch-action: none;
            width: 100vw;
            height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #game-container {
            position: relative;
            width: 100%;
            height: 100dvh;
            max-width: 500px;
            max-height: 100dvh;
            background-color: #050505;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        canvas { display: block; width: 100%; height: 100%; }
        .ui-layer { position: absolute; inset: 0; z-index: 10; pointer-events: none; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); box-sizing: border-box; }
        .interactive { pointer-events: auto; }
        #hub-link { position: static; }
        .glow-text { text-shadow: 0 0 10px rgba(0, 255, 255, 0.6); }
        .btn-main { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%); color: black; font-weight: 800; }
        .btn-sub { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border); backdrop-filter: blur(5px); }
        .btn-sub:active { transform: scale(0.95); background: rgba(0, 255, 255, 0.2); }
        .stage-container { border-top: 1px solid rgba(255, 255, 255, 0.1); border-bottom: 1px solid rgba(255, 255, 255, 0.1); background: rgba(0,0,0,0.3); backdrop-filter: blur(2px); width: 100%; }
        .skill-card { background: rgba(20, 20, 20, 0.9); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.2s; cursor: pointer; }
        .skill-card:hover { transform: translateY(-5px); border-color: #00ffff; box-shadow: 0 0 20px rgba(0, 255, 255, 0.2); background: rgba(30, 30, 30, 0.95); }
        .skill-card.unlock { border-color: #ffaa00; } 
        .skill-card.unlock:hover { border-color: #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .msg-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .lobby-layout { padding: 0 var(--pad); gap: 12px; }
        .top-bar { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding-top: 0.5rem; }
        .title-block { flex: 1; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .title-block h1 { font-size: 1.5rem; font-weight: 900; letter-spacing: -0.02em; line-height: 1; }
        .version-toggle { font-size: 10px; letter-spacing: 0.35em; text-transform: uppercase; color: rgba(103, 232, 249, 0.9); padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(103, 232, 249, 0.35); background: rgba(0, 0, 0, 0.4); }
        .resource-stack { display: flex; flex-direction: column; gap: 6px; align-items: flex-end; min-width: 96px; }
        .resource-pill { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); background: rgba(0, 0, 0, 0.55); min-width: 96px; font-size: 12px; }
        .resource-pill span:last-child { font-weight: 800; }
        .tap-target { min-width: 44px; min-height: 44px; }
        .difficulty-toggle { display: flex; width: min(94%, 360px); border-radius: 999px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border); overflow: hidden; }
        .diff-btn { flex: 1; padding: 10px 0; font-size: 11px; font-weight: 800; letter-spacing: 0.2em; transition: all 0.2s; text-transform: uppercase; }
        .diff-btn.active { color: #050505; }
        .diff-btn.normal { color: rgba(255, 255, 255, 0.7); }
        .diff-btn.hard { color: rgba(255, 255, 255, 0.7); }
        .diff-btn.active.normal { background: var(--accent); box-shadow: 0 0 15px rgba(0, 255, 255, 0.4); }
        .diff-btn.active.hard { background: var(--accent-hard); box-shadow: 0 0 15px rgba(255, 51, 102, 0.4); }
        .stage-card { width: min(94%, 420px); padding: 22px 16px; border-radius: var(--radius-lg); border: 1px solid var(--border); background: rgba(8, 8, 8, 0.65); box-shadow: var(--shadow); }
        .stage-nav { display: flex; align-items: center; justify-content: space-between; gap: 12px; width: 100%; }
        .stage-arrow { width: 48px; height: 48px; border-radius: 999px; border: 1px solid var(--border); background: rgba(255, 255, 255, 0.05); display: flex; align-items: center; justify-content: center; font-size: 20px; color: rgba(255, 255, 255, 0.6); transition: all 0.2s; }
        .stage-arrow:active { transform: scale(0.95); }
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; border: 1px solid var(--border); background: rgba(255, 255, 255, 0.05); font-size: 10px; letter-spacing: 0.2em; text-transform: uppercase; color: rgba(255, 255, 255, 0.7); }
        .bottom-bar { display: grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 10px; padding-bottom: calc(0.75rem + env(safe-area-inset-bottom)); }
        .nav-btn { height: 56px; border-radius: var(--radius); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; font-size: 18px; color: rgba(255, 255, 255, 0.85); }
        .nav-label { font-size: 9px; font-weight: 800; letter-spacing: 0.18em; color: rgba(255, 255, 255, 0.4); }
        #start-btn { height: 66px; border-radius: 22px; font-size: clamp(14px, 3.6vw, 16px); letter-spacing: 0.18em; }
        .hidden { display: none !important; }
        body.modal-open { overflow: hidden; }
        #dev-panel-overlay,
        #test-config-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            pointer-events: auto;
            padding-bottom: env(safe-area-inset-bottom);
        }
        #dev-panel-backdrop,
        #test-config-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            pointer-events: auto;
        }
        .dev-sheet,
        .test-sheet {
            position: relative;
            width: min(100%, 500px);
            padding: 18px 16px calc(20px + env(safe-area-inset-bottom));
            border-radius: 22px 22px 0 0;
            border: 1px solid var(--border);
            background: rgba(6, 6, 6, 0.96);
            box-shadow: var(--shadow);
            pointer-events: auto;
        }
        .dev-sheet-title,
        .test-sheet-title { font-size: 12px; letter-spacing: 0.35em; text-transform: uppercase; color: rgba(255, 255, 255, 0.5); text-align: center; margin-bottom: 12px; }
        .dev-sheet-actions { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
        .test-sheet-desc { font-size: 12px; text-align: center; color: rgba(255, 255, 255, 0.7); margin-bottom: 12px; }
        .test-sheet-actions { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; margin-top: 12px; }
        #test-weapon-select {
            width: 100%;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.45);
            color: white;
        }
        .dev-btn { padding: 12px 10px; border-radius: 14px; font-size: 11px; font-weight: 800; letter-spacing: 0.2em; text-transform: uppercase; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        #rotate-overlay .rotate-continue-btn{
            margin-top:18px; min-height:44px; padding:12px 18px;
            border-radius:14px;
            border:1px solid rgba(0,255,255,.25);
            background:rgba(0,0,0,.35);
            color:rgba(200,255,255,.92);
            font-weight:800; letter-spacing:.08em;
            backdrop-filter: blur(10px);
        }
        #rotate-overlay .rotate-continue-btn:active{
            transform:scale(.98); filter:brightness(1.08);
        }
        #btn-upgr { pointer-events: auto; }
        .meta-upgrade-overlay { position: absolute; inset: 0; z-index: 60; display: flex; align-items: center; justify-content: center; padding: 18px; }
        .meta-upgrade-overlay.hidden { display: none; }
        .meta-upgrade-backdrop { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.7); }
        .meta-upgrade-sheet { position: relative; width: min(96%, 480px); max-height: 85dvh; border-radius: 20px; border: 1px solid var(--border); background: rgba(6, 6, 6, 0.95); box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; }
        .meta-upgrade-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 16px 18px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); }
        .meta-upgrade-title { font-size: 14px; font-weight: 800; letter-spacing: 0.3em; text-transform: uppercase; color: rgba(103, 232, 249, 0.9); }
        .meta-upgrade-close { min-width: 44px; min-height: 44px; border-radius: 12px; border: 1px solid var(--border); background: rgba(0, 0, 0, 0.4); color: rgba(255, 255, 255, 0.7); font-size: 12px; font-weight: 800; letter-spacing: 0.2em; }
        .meta-upgrade-resources { display: flex; gap: 8px; padding: 12px 18px 0; }
        .meta-upgrade-pill { flex: 1; border-radius: 999px; border: 1px solid var(--border); background: rgba(0, 0, 0, 0.5); padding: 8px 12px; display: flex; align-items: center; justify-content: space-between; font-size: 12px; }
        .meta-upgrade-list { padding: 14px 18px 18px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .meta-upgrade-item { display: grid; grid-template-columns: 1fr auto; gap: 10px; padding: 12px; border-radius: 16px; border: 1px solid var(--border); background: rgba(255, 255, 255, 0.04); }
        .meta-upgrade-item h4 { margin: 0; font-size: 12px; letter-spacing: 0.12em; }
        .meta-upgrade-item p { margin: 4px 0 0; font-size: 10px; color: rgba(255, 255, 255, 0.6); }
        .meta-upgrade-buy { min-width: 96px; min-height: 44px; border-radius: 12px; border: 1px solid rgba(0, 255, 255, 0.25); background: rgba(0, 0, 0, 0.35); color: rgba(200, 255, 255, 0.92); font-weight: 800; font-size: 11px; letter-spacing: 0.18em; }
        .meta-upgrade-buy:disabled { opacity: 0.35; }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="rotate-overlay" class="hidden absolute inset-0 z-[999] bg-black/90 backdrop-blur-md flex items-center justify-center text-center p-8">
            <div>
                <div class="text-3xl font-black italic text-cyan-300 glow-text">Í≤åÏûÑÌôîÎ©¥Ïóê ÎßûÍ≤å<br/>ÏÑ∏Î°úÎ°ú Ï∞ΩÏùÑ Ï°∞Ï†àÌï¥ Ï£ºÏÑ∏Ïöî</div>
                <div class="mt-3 text-xs text-gray-400 tracking-widest">PORTRAIT MODE RECOMMENDED</div>
                <button id="rotate-continue" class="rotate-continue-btn" type="button">Í≥ÑÏÜç ÏßÑÌñâ</button>
            </div>
        </div>

        <!-- Î°úÎπÑ UI -->
        <div id="lobby-ui" class="ui-layer lobby-layout flex flex-col mx-auto w-full h-full">
            <div class="top-bar interactive">
                <a id="hub-link" href="../" class="tap-target px-3 py-2 rounded-lg text-xs font-black tracking-widest text-cyan-200 border border-cyan-300/30 bg-black/40 backdrop-blur-md" aria-label="HUBÎ°ú Ïù¥Îèô">
                    HUB
                </a>
                <div class="title-block">
                    <h1 class="italic glow-text">GEOMETRY<br>CANNON</h1>
                    <button id="version-toggle" class="version-toggle tap-target" type="button" aria-label="Î≤ÑÏ†Ñ 5Ìöå ÌÉ≠ Ïãú DEV Ìå®ÎÑê">
                    <span id="version-text">v37.2.1</span>
                    </button>
                </div>
                <div class="resource-stack">
                    <div class="resource-pill">
                        <span class="text-cyan-300 text-xs">‚óÜ</span>
                        <span id="lobby-fragments" class="font-mono text-sm text-cyan-100">0</span>
                    </div>
                    <div class="resource-pill">
                        <span class="text-orange-300 text-xs">‚¨¢</span>
                        <span id="lobby-cores" class="font-mono text-sm text-orange-100">0</span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col items-center justify-center w-full gap-6 mt-3">
                <div class="difficulty-toggle interactive">
                    <button id="diff-normal" class="diff-btn normal active tap-target" onclick="setDifficulty('NORMAL')">NORMAL</button>
                    <button id="diff-hard" class="diff-btn hard tap-target" onclick="setDifficulty('HARD')">HARD</button>
                </div>

                <div class="stage-card flex flex-col items-center gap-3">
                    <div class="stage-nav interactive">
                        <button id="prev-stage" class="stage-arrow tap-target" onclick="changeStage(-1)" aria-label="Ïù¥Ï†Ñ Ïä§ÌÖåÏù¥ÏßÄ">‚óÄ</button>
                        <div class="text-center">
                            <div id="stage-num" class="text-cyan-400 text-xs font-black tracking-[0.3em]">STAGE 01</div>
                            <div id="stage-name" class="text-3xl font-black tracking-tight italic text-white mt-2">NEON GRID</div>
                        </div>
                        <button id="next-stage" class="stage-arrow tap-target" onclick="changeStage(1)" aria-label="Îã§Ïùå Ïä§ÌÖåÏù¥ÏßÄ">‚ñ∂</button>
                    </div>
                    <div class="flex items-center justify-center">
                        <span class="status-badge">
                            <span id="status-dot" class="w-1.5 h-1.5 rounded-full bg-gray-600"></span>
                            <span id="status-text">LOCKED</span>
                        </span>
                    </div>
                </div>
                <div class="h-8 text-white/20 text-[10px] tracking-widest uppercase">Target Systems Ready</div>
            </div>

            <div class="bottom-bar interactive mt-auto">
                <button class="btn-sub nav-btn tap-target" aria-label="ÏÑ§Ï†ï">‚öôÔ∏è</button>
                <button id="btn-upgr" class="btn-sub nav-btn tap-target" aria-label="ÏóÖÍ∑∏Î†àÏù¥Îìú">
                    <span class="nav-label">UPGR</span>
                    ‚öîÔ∏è
                </button>
                <button id="start-btn" class="btn-main tap-target flex items-center justify-center shadow-lg shadow-cyan-500/30 transform active:scale-95 transition-all" onclick="prepareGame(false)" aria-label="Í≤åÏûÑ ÏãúÏûë">START</button>
                <button class="btn-sub nav-btn tap-target" aria-label="ÏÉÅÏ†ê">
                    <span class="nav-label">SHOP</span>
                    üíé
                </button>
                <button class="btn-sub nav-btn tap-target" aria-label="Îû≠ÌÇπ">
                    <span class="nav-label">RANK</span>
                    üèÜ
                </button>
            </div>

            <div class="absolute bottom-2 left-4 text-[10px] text-gray-600 font-mono">
                DATA: <span id="debug-save-status">Checking...</span>
            </div>
        </div>

        <div id="dev-panel-overlay" class="hidden">
            <button id="dev-panel-backdrop" type="button" aria-label="Close dev panel"></button>
            <div class="dev-sheet" role="dialog" aria-modal="true">
                <div class="dev-sheet-title">DEV PANEL</div>
                <div class="dev-sheet-actions">
                    <button id="dev-god-btn" class="dev-btn bg-red-900/80 border border-red-500/50 text-red-200 hover:bg-red-600 transition-colors" type="button">GOD MODE</button>
                    <button id="dev-test-btn" class="dev-btn bg-orange-600 border border-orange-400 text-white hover:bg-orange-500 transition-colors shadow-[0_0_10px_orange]" type="button">TEST STAGE</button>
                </div>
            </div>
        </div>
        <div id="test-config-overlay" class="hidden">
            <button id="test-config-backdrop" type="button" aria-label="Close test config"></button>
            <div class="test-sheet" role="dialog" aria-modal="true">
                <div class="test-sheet-title">TEST MODE</div>
                <div class="test-sheet-desc">ÌäπÏàò Î¨¥Í∏∞Î•º ÏÑ†ÌÉùÌïòÎ©¥ Îã§Ïùå Ï†ÑÌà¨ÏóêÏÑú Ìï¥Îãπ Î¨¥Í∏∞Î°ú ÏãúÏûëÌï©ÎãàÎã§.</div>
                <select id="test-weapon-select"></select>
                <div class="test-sheet-actions">
                    <button id="test-config-close" class="btn-sub" type="button">Îã´Í∏∞</button>
                    <button id="test-apply-btn" class="btn-main" type="button">Ï†ÅÏö©</button>
                </div>
            </div>
        </div>

        <div id="meta-upgrade-overlay" class="meta-upgrade-overlay hidden" role="dialog" aria-modal="true" aria-label="Î©îÌÉÄ ÏóÖÍ∑∏Î†àÏù¥Îìú">
            <button id="meta-upgrade-backdrop" class="meta-upgrade-backdrop" type="button" aria-label="Î©îÌÉÄ ÏóÖÍ∑∏Î†àÏù¥Îìú Îã´Í∏∞"></button>
            <div class="meta-upgrade-sheet">
                <div class="meta-upgrade-header">
                    <div class="meta-upgrade-title">UPGR</div>
                    <button id="meta-upgrade-close" class="meta-upgrade-close" type="button">CLOSE</button>
                </div>
                <div class="meta-upgrade-resources">
                    <div class="meta-upgrade-pill">
                        <span class="text-cyan-300">‚óÜ</span>
                        <span id="meta-upgrade-fragments" class="font-mono text-cyan-100">0</span>
                    </div>
                    <div class="meta-upgrade-pill">
                        <span class="text-orange-300">‚¨¢</span>
                        <span id="meta-upgrade-cores" class="font-mono text-orange-100">0</span>
                    </div>
                </div>
                <div id="meta-upgrade-list" class="meta-upgrade-list"></div>
            </div>
        </div>

        <!-- Ïù∏Í≤åÏûÑ UI -->
        <div id="ingame-ui" class="hidden ui-layer flex flex-col justify-between p-4 pointer-events-none mx-auto w-full h-full">
            <div class="flex justify-between items-start w-full">
                <div class="flex gap-2">
                    <div class="bg-black/50 px-4 py-2 rounded-lg backdrop-blur-md border border-white/10">
                        <div class="text-[10px] text-gray-400">STAGE</div>
                        <!-- [NEW] Ïù∏Í≤åÏûÑ Ïä§ÌÖåÏù¥ÏßÄ ÌëúÏãú -->
                        <div id="ingame-stage" class="text-xl font-bold text-white">1</div>
                    </div>
                    <div class="bg-black/50 px-4 py-2 rounded-lg backdrop-blur-md border border-white/10">
                        <div class="text-[10px] text-gray-400">WAVE</div>
                        <div id="wave-text" class="text-xl font-bold text-cyan-400">1</div>
                    </div>
                </div>
                <div class="bg-black/50 px-4 py-1 rounded-lg backdrop-blur-md border border-white/10 flex flex-col items-center min-w-[100px]">
                    <div class="text-[9px] text-gray-400 tracking-widest">TIME LEFT</div>
                    <div id="timer-text" class="text-2xl font-mono font-bold text-white tracking-widest tabular-nums">01:00.00</div>
                </div>
                <div id="test-mode-indicator" class="hidden bg-orange-500/20 border border-orange-400/60 px-3 py-2 rounded-lg text-[10px] font-black tracking-[0.3em] text-orange-200">
                    TEST MODE
                </div>
                <button id="btn-quit" class="pointer-events-auto bg-red-500/20 hover:bg-red-500/50 border border-red-500/50 px-3 py-2 rounded-lg text-xs font-bold text-red-100 transition-all" onclick="showQuitPopup()">EXIT</button>
            </div>
            
            <div id="center-msg-overlay" class="absolute inset-0 flex items-center justify-center hidden pointer-events-none">
                <h1 id="center-msg-text" class="text-4xl md:text-6xl font-black italic text-center glow-text text-white tracking-tighter msg-pop leading-tight">Ï†ÅÏù¥ Î™∞Î†§ÏòµÎãàÎã§ !!!</h1>
            </div>

            <div class="flex flex-col gap-3 mt-auto mb-2 w-full max-w-md mx-auto px-2">
                <div class="flex gap-4 justify-center text-[10px] font-mono text-gray-400 opacity-80">
                    <span>GET: <span class="text-cyan-400">‚óÜ</span> <span id="ingame-fragments">0</span></span>
                    <span>GET: <span class="text-orange-400">‚¨¢</span> <span id="ingame-cores">0</span></span>
                </div>
                <div class="flex flex-col gap-1">
                    <div class="flex justify-between items-end">
                        <div class="text-[10px] text-cyan-400 font-bold tracking-widest">SHIELD INTEGRITY</div>
                        <div class="text-[10px] text-cyan-400 font-mono" id="hp-text">100/100</div>
                    </div>
                    <div class="w-full bg-gray-900 h-2.5 rounded-full overflow-hidden border border-cyan-500/30">
                        <div id="hp-bar" class="bg-cyan-500 h-full transition-all duration-300 shadow-[0_0_10px_#00ffff]" style="width: 100%"></div>
                    </div>
                </div>
                <div class="flex flex-col gap-1">
                    <div class="flex justify-between text-[10px] text-purple-300 font-bold px-0.5">
                        <span>LV. <span id="level-text">1</span></span>
                        <span id="exp-text">0%</span>
                    </div>
                    <div class="w-full bg-gray-900 h-1.5 rounded-full overflow-hidden border border-purple-500/30">
                        <div id="exp-bar" class="bg-purple-500 h-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Overlays -->

            <div id="clear-overlay" class="hidden absolute inset-0 bg-black/80 backdrop-blur-md flex flex-col items-center justify-center pointer-events-auto z-50 p-6">
                <h2 class="text-5xl font-black italic text-yellow-400 mb-2 glow-text tracking-tighter">STAGE CLEAR!</h2>
                <div class="flex flex-col gap-4 w-full max-w-xs">
                    <button id="btn-next-stage" class="bg-white text-black py-4 rounded-xl font-black text-lg hover:bg-cyan-400 hover:scale-105 transition-all shadow-[0_0_20px_rgba(255,255,255,0.3)]" onclick="nextStage()">Îã§Ïùå Ïä§ÌÖåÏù¥ÏßÄ ÎèÑÏ†Ñ ‚ñ∂</button>
                    <button id="btn-clear-lobby" class="bg-transparent border border-white/20 text-white py-3 rounded-xl font-bold text-sm hover:bg-white/10 transition-all" onclick="returnToLobby()">Î©îÏù∏ ÌôîÎ©¥ÏúºÎ°ú</button>
                </div>
            </div>
            <div id="upgrade-overlay" class="hidden absolute inset-0 bg-black/80 backdrop-blur-md flex flex-col items-center justify-center pointer-events-auto z-40 p-6">
                <h2 id="upgrade-title" class="text-3xl font-black italic text-yellow-400 mb-2 glow-text">LEVEL UP!</h2>
                <p id="upgrade-subtitle" class="text-gray-400 text-xs mb-8 tracking-widest">SELECT UPGRADE MODULE</p>
                <div id="card-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full max-w-2xl"></div>
            </div>
            <div id="gameover-popup" class="hidden absolute inset-0 bg-red-900/40 backdrop-blur-md flex flex-col items-center justify-center pointer-events-auto z-50">
                <h2 class="text-4xl font-black italic text-red-500 mb-2 glow-text">SYSTEM DESTROYED</h2>
                <div class="flex gap-4">
                    <button id="btn-retry" class="bg-white text-black px-8 py-3 rounded-full font-bold hover:bg-red-400" onclick="prepareGame(isTestStage)">Ïû¨ÎèÑÏ†Ñ</button>
                    <button id="btn-fail-lobby" class="bg-black/50 border border-white/20 text-white px-6 py-3 rounded-full font-bold hover:bg-white/10" onclick="returnToLobby()">Î©îÏù∏ÏúºÎ°ú</button>
                </div>
            </div>
            <div id="quit-overlay" class="hidden absolute inset-0 bg-black/90 backdrop-blur-md flex flex-col items-center justify-center pointer-events-auto z-50 p-8 text-center">
                <h2 class="text-2xl font-bold text-white mb-2">Ï†ÑÌà¨Î•º Ìè¨Í∏∞ÌïòÏãúÍ≤†ÏäµÎãàÍπå?</h2>
                <p class="text-red-400 text-sm mb-8">ÏßÄÍ∏à ÎÇòÍ∞ÄÎ©¥ ÌöçÎìùÌïú ÏïÑÏù¥ÌÖúÏù¥ Î™®Îëê ÏÇ¨ÎùºÏßëÎãàÎã§.</p>
                <div class="flex gap-4 w-full max-w-xs">
                    <button id="btn-quit-confirm" class="flex-1 bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-500" onclick="quitGame()">Ìè¨Í∏∞ÌïòÍ∏∞</button>
                    <button id="btn-quit-cancel" class="flex-1 bg-gray-700 text-white py-3 rounded-lg font-bold hover:bg-gray-600" onclick="cancelQuit()">Í≥ÑÏÜçÌïòÍ∏∞</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener('load', () => {
            const stageCard = document.querySelector('.stage-card');

            if (stageCard) {
                let touchStartX = 0;
                stageCard.addEventListener('touchstart', (event) => {
                    touchStartX = event.changedTouches[0].screenX;
                }, { passive: true });

                stageCard.addEventListener('touchend', (event) => {
                    const deltaX = event.changedTouches[0].screenX - touchStartX;
                    if (Math.abs(deltaX) > 40) {
                        if (deltaX > 0) {
                            window.changeStage?.(-1);
                        } else {
                            window.changeStage?.(1);
                        }
                    }
                }, { passive: true });
            }
        });
    </script>
    <script type="module" src="./src/main.js"></script>
</body>

</html>
